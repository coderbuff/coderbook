<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>复杂搜索 | CoderBook</title>
    <meta name="description" content="CoderBook">
    
    
    <link rel="preload" href="/coderbook/assets/css/0.styles.414cd468.css" as="style"><link rel="preload" href="/coderbook/assets/js/app.12a8b8f4.js" as="script"><link rel="preload" href="/coderbook/assets/js/2.a6e63a56.js" as="script"><link rel="preload" href="/coderbook/assets/js/16.068faf54.js" as="script"><link rel="preload" href="/coderbook/assets/js/4.dd78fc5c.js" as="script"><link rel="prefetch" href="/coderbook/assets/js/10.e27e1a66.js"><link rel="prefetch" href="/coderbook/assets/js/11.8f02b96e.js"><link rel="prefetch" href="/coderbook/assets/js/12.41dedc60.js"><link rel="prefetch" href="/coderbook/assets/js/13.70f168a9.js"><link rel="prefetch" href="/coderbook/assets/js/14.d032a864.js"><link rel="prefetch" href="/coderbook/assets/js/15.03e4e0ca.js"><link rel="prefetch" href="/coderbook/assets/js/17.eadfba8c.js"><link rel="prefetch" href="/coderbook/assets/js/18.4eca4c1c.js"><link rel="prefetch" href="/coderbook/assets/js/19.fc85f6ab.js"><link rel="prefetch" href="/coderbook/assets/js/3.1f9a9b51.js"><link rel="prefetch" href="/coderbook/assets/js/5.8242e3e9.js"><link rel="prefetch" href="/coderbook/assets/js/6.e9c0d273.js"><link rel="prefetch" href="/coderbook/assets/js/7.9beab6ce.js"><link rel="prefetch" href="/coderbook/assets/js/8.403353f2.js"><link rel="prefetch" href="/coderbook/assets/js/9.6be91fe2.js">
    <link rel="stylesheet" href="/coderbook/assets/css/0.styles.414cd468.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/coderbook/" class="home-link router-link-active"><!----> <span class="site-name">CoderBook</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/coderbook/" class="nav-link">首页</a></div><div class="nav-item"><a href="/coderbook/es6/index.html" class="nav-link">ElasticSearch6.x</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/coderbook/" class="nav-link">首页</a></div><div class="nav-item"><a href="/coderbook/es6/index.html" class="nav-link">ElasticSearch6.x</a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/coderbook/es6/" class="sidebar-link">写在前面的话</a></li><li><a href="/coderbook/es6/chapter1.html" class="sidebar-link">准备工作</a></li><li><a href="/coderbook/es6/chapter2.html" class="sidebar-link">基本术语</a></li><li><a href="/coderbook/es6/chapter3.html" class="sidebar-link">简单的API</a></li><li><a href="/coderbook/es6/chapter4.html" class="sidebar-link">分词</a></li><li><a href="/coderbook/es6/chapter5.html" class="sidebar-link">简单搜索</a></li><li><a href="/coderbook/es6/chapter6.html" class="sidebar-link">Java客户端（上）</a></li><li><a href="/coderbook/es6/chapter7.html" class="sidebar-link">父-子关系文档</a></li><li><a href="/coderbook/es6/chapter8.html" class="active sidebar-link">复杂搜索</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/coderbook/es6/chapter8.html#场景1" class="sidebar-link">场景1</a></li><li class="sidebar-sub-header"><a href="/coderbook/es6/chapter8.html#场景2" class="sidebar-link">场景2</a></li></ul></li><li><a href="/coderbook/es6/chapter9.html" class="sidebar-link">Java客户端（下）</a></li><li><a href="/coderbook/es6/chapter10.html" class="sidebar-link">实战：ELK日志分析系统</a></li><li><a href="/coderbook/es6/chapter11.html" class="sidebar-link">实战：多数据源同步</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="复杂搜索"><a href="#复杂搜索" class="header-anchor">#</a> 复杂搜索</h1> <blockquote><p>黑夜给了我黑色的眼睛，我却用它寻找光明。</p></blockquote> <p>经过了解简单的API和简单搜索，已经基本上能应付大部分的使用场景。可是非关系型数据库数据的文档数据往往又多又杂，各种各样冗余的字段，组成了一条&quot;记录&quot;。复杂的数据结构，带来的就是复杂的搜索。所以在进入本章节前，我们要构建一个尽可能&quot;复杂&quot;的数据结构。</p> <p>下面分为两个场景，场景1偏向数据结构上的复杂并且介绍<strong>聚合查询</strong>、<strong>指定字段返回</strong>、<strong>深分页</strong>，场景2偏向搜索精度上的复杂。</p> <h2 id="场景1"><a href="#场景1" class="header-anchor">#</a> 场景1</h2> <p>存储一个公司的员工，员工信息包含姓名、工号、性别、出生年月日、岗位、上级、下级、所在部门、进入公司时间、修改时间、创建时间。其中员工工号作为主键ID全局唯一，员工只有一个直属上级，但有多个下级，可以通过父子文档实现。员工有可能属于多个部门（特别是领导可能兼任多个部门的负责人）。</p> <h3 id="数据结构"><a href="#数据结构" class="header-anchor">#</a> 数据结构</h3> <p>创建索引并定义映射结构：</p> <div class="language-json extra-class"><pre class="language-json"><code>PUT http<span class="token operator">:</span><span class="token comment">//localhost:9200/company</span>
<span class="token punctuation">{</span>
	<span class="token property">&quot;mappings&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
		<span class="token property">&quot;employee&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
			<span class="token property">&quot;properties&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
				<span class="token property">&quot;id&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
					<span class="token property">&quot;type&quot;</span><span class="token operator">:</span><span class="token string">&quot;keyword&quot;</span>
				<span class="token punctuation">}</span><span class="token punctuation">,</span>
				<span class="token property">&quot;name&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
					<span class="token property">&quot;type&quot;</span><span class="token operator">:</span><span class="token string">&quot;text&quot;</span><span class="token punctuation">,</span>
					<span class="token property">&quot;analyzer&quot;</span><span class="token operator">:</span><span class="token string">&quot;ik_smart&quot;</span><span class="token punctuation">,</span>
					<span class="token property">&quot;fields&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
						<span class="token property">&quot;keyword&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
							<span class="token property">&quot;type&quot;</span><span class="token operator">:</span><span class="token string">&quot;keyword&quot;</span><span class="token punctuation">,</span>
							<span class="token property">&quot;ignore_above&quot;</span><span class="token operator">:</span><span class="token number">256</span>
						<span class="token punctuation">}</span>
					<span class="token punctuation">}</span>
				<span class="token punctuation">}</span><span class="token punctuation">,</span>
				<span class="token property">&quot;sex&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
					<span class="token property">&quot;type&quot;</span><span class="token operator">:</span><span class="token string">&quot;keyword&quot;</span>
				<span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token property">&quot;age&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
          <span class="token property">&quot;type&quot;</span><span class="token operator">:</span><span class="token string">&quot;integer&quot;</span>
				<span class="token punctuation">}</span><span class="token punctuation">,</span>
				<span class="token property">&quot;birthday&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
					<span class="token property">&quot;type&quot;</span><span class="token operator">:</span><span class="token string">&quot;date&quot;</span>
				<span class="token punctuation">}</span><span class="token punctuation">,</span>
				<span class="token property">&quot;position&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
					<span class="token property">&quot;type&quot;</span><span class="token operator">:</span><span class="token string">&quot;text&quot;</span><span class="token punctuation">,</span>
					<span class="token property">&quot;analyzer&quot;</span><span class="token operator">:</span><span class="token string">&quot;ik_smart&quot;</span><span class="token punctuation">,</span>
					<span class="token property">&quot;fields&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
						<span class="token property">&quot;keyword&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
							<span class="token property">&quot;type&quot;</span><span class="token operator">:</span><span class="token string">&quot;keyword&quot;</span><span class="token punctuation">,</span>
							<span class="token property">&quot;ignore_above&quot;</span><span class="token operator">:</span><span class="token number">256</span>
						<span class="token punctuation">}</span>
					<span class="token punctuation">}</span>
				<span class="token punctuation">}</span><span class="token punctuation">,</span>
				<span class="token property">&quot;level&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
					<span class="token property">&quot;type&quot;</span><span class="token operator">:</span><span class="token string">&quot;join&quot;</span><span class="token punctuation">,</span>
					<span class="token property">&quot;relations&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
						<span class="token property">&quot;superior&quot;</span><span class="token operator">:</span><span class="token string">&quot;staff&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;staff&quot;</span><span class="token operator">:</span><span class="token string">&quot;junior&quot;</span>
					<span class="token punctuation">}</span>
				<span class="token punctuation">}</span><span class="token punctuation">,</span>
				<span class="token property">&quot;departments&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
					<span class="token property">&quot;type&quot;</span><span class="token operator">:</span><span class="token string">&quot;text&quot;</span><span class="token punctuation">,</span>
					<span class="token property">&quot;analyzer&quot;</span><span class="token operator">:</span><span class="token string">&quot;ik_smart&quot;</span><span class="token punctuation">,</span>
					<span class="token property">&quot;fields&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
						<span class="token property">&quot;keyword&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
							<span class="token property">&quot;type&quot;</span><span class="token operator">:</span><span class="token string">&quot;keyword&quot;</span><span class="token punctuation">,</span>
							<span class="token property">&quot;ignore_above&quot;</span><span class="token operator">:</span><span class="token number">256</span>
						<span class="token punctuation">}</span>
					<span class="token punctuation">}</span>
				<span class="token punctuation">}</span><span class="token punctuation">,</span>
				<span class="token property">&quot;joinTime&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
					<span class="token property">&quot;type&quot;</span><span class="token operator">:</span><span class="token string">&quot;date&quot;</span>
				<span class="token punctuation">}</span><span class="token punctuation">,</span>
				<span class="token property">&quot;modified&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
					<span class="token property">&quot;type&quot;</span><span class="token operator">:</span><span class="token string">&quot;date&quot;</span>
				<span class="token punctuation">}</span><span class="token punctuation">,</span>
				<span class="token property">&quot;created&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
					<span class="token property">&quot;type&quot;</span><span class="token operator">:</span><span class="token string">&quot;date&quot;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="数据"><a href="#数据" class="header-anchor">#</a> 数据</h3> <p>接下来是构造数据，我们构造几条关键数据。</p> <ul><li>张三是公司的董事长，他是最大的领导，不属于任何部门。</li> <li>李四的上级是张三，他的下级是王五、赵六、孙七、周八，他同时是市场部和研发部的负责人，也就是隶属于市场部和研发部。</li> <li>王五、赵六的上级是张三，他没有下级，他隶属于市场部。</li> <li>孙七、周八的上级是李四，他没有下级，他隶属于研发部。</li></ul> <p>更为全面直观的数据如下表所示：</p> <table><thead><tr><th>姓名</th> <th>工号</th> <th>性别</th> <th>年龄</th> <th>出生年月日</th> <th>岗位</th> <th>上级</th> <th>下级</th> <th>部门</th> <th>进入公司时间</th> <th>修改时间</th> <th>创建时间</th></tr></thead> <tbody><tr><td>张三</td> <td>1</td> <td>男</td> <td>49</td> <td>1970-01-01</td> <td>董事长</td> <td>/</td> <td>李四</td> <td>/</td> <td>1990-01-01</td> <td>1562167817000</td> <td>1562167817000</td></tr> <tr><td>李四</td> <td>2</td> <td>男</td> <td>39</td> <td>1980-04-03</td> <td>总经理</td> <td>张三</td> <td>王五、赵六、孙七、周八</td> <td>市场部、研发部</td> <td>2001-02-02</td> <td>1562167817000</td> <td>1562167817000</td></tr> <tr><td>王五</td> <td>3</td> <td>女</td> <td>27</td> <td>1992-09-01</td> <td>销售</td> <td>李四</td> <td>/</td> <td>市场部</td> <td>2010-07-01</td> <td>1562167817000</td> <td>1562167817000</td></tr> <tr><td>赵六</td> <td>4</td> <td>男</td> <td>29</td> <td>1990-10-10</td> <td>销售</td> <td>李四</td> <td>/</td> <td>市场部</td> <td>2010-08-08</td> <td>1562167817000</td> <td>1562167817000</td></tr> <tr><td>孙七</td> <td>5</td> <td>男</td> <td>26</td> <td>1993-12-10</td> <td>前端工程师</td> <td>李四</td> <td>/</td> <td>研发部</td> <td>2016-07-01</td> <td>1562167817000</td> <td>1562167817000</td></tr> <tr><td>周八</td> <td>6</td> <td>男</td> <td>25</td> <td>1994-05-11</td> <td>Java工程师</td> <td>李四</td> <td>/</td> <td>研发部</td> <td>2018-03-10</td> <td>1562167817000</td> <td>1562167817000</td></tr></tbody></table> <p>插入6条数据：</p> <div class="language-json extra-class"><pre class="language-json"><code>POST http<span class="token operator">:</span><span class="token comment">//localhost:9200/company/employee/1?routing=1</span>
<span class="token punctuation">{</span>
	<span class="token property">&quot;id&quot;</span><span class="token operator">:</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">,</span>
	<span class="token property">&quot;name&quot;</span><span class="token operator">:</span><span class="token string">&quot;张三&quot;</span><span class="token punctuation">,</span>
	<span class="token property">&quot;sex&quot;</span><span class="token operator">:</span><span class="token string">&quot;男&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;age&quot;</span><span class="token operator">:</span><span class="token number">49</span><span class="token punctuation">,</span>
	<span class="token property">&quot;birthday&quot;</span><span class="token operator">:</span><span class="token string">&quot;1970-01-01&quot;</span><span class="token punctuation">,</span>
	<span class="token property">&quot;position&quot;</span><span class="token operator">:</span><span class="token string">&quot;董事长&quot;</span><span class="token punctuation">,</span>
	<span class="token property">&quot;level&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
    <span class="token property">&quot;name&quot;</span><span class="token operator">:</span><span class="token string">&quot;superior&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token property">&quot;joinTime&quot;</span><span class="token operator">:</span><span class="token string">&quot;1990-01-01&quot;</span><span class="token punctuation">,</span>
	<span class="token property">&quot;modified&quot;</span><span class="token operator">:</span><span class="token string">&quot;1562167817000&quot;</span><span class="token punctuation">,</span>
	<span class="token property">&quot;created&quot;</span><span class="token operator">:</span><span class="token string">&quot;1562167817000&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-json extra-class"><pre class="language-json"><code>POST http<span class="token operator">:</span><span class="token comment">//localhost:9200/company/employee/2?routing=1</span>
<span class="token punctuation">{</span>
	<span class="token property">&quot;id&quot;</span><span class="token operator">:</span><span class="token string">&quot;2&quot;</span><span class="token punctuation">,</span>
	<span class="token property">&quot;name&quot;</span><span class="token operator">:</span><span class="token string">&quot;李四&quot;</span><span class="token punctuation">,</span>
	<span class="token property">&quot;sex&quot;</span><span class="token operator">:</span><span class="token string">&quot;男&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;age&quot;</span><span class="token operator">:</span><span class="token number">39</span><span class="token punctuation">,</span>
	<span class="token property">&quot;birthday&quot;</span><span class="token operator">:</span><span class="token string">&quot;1980-04-03&quot;</span><span class="token punctuation">,</span>
	<span class="token property">&quot;position&quot;</span><span class="token operator">:</span><span class="token string">&quot;总经理&quot;</span><span class="token punctuation">,</span>
	<span class="token property">&quot;level&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
    <span class="token property">&quot;name&quot;</span><span class="token operator">:</span><span class="token string">&quot;staff&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;parent&quot;</span><span class="token operator">:</span><span class="token string">&quot;1&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;departments&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token string">&quot;市场部&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;研发部&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
	<span class="token property">&quot;joinTime&quot;</span><span class="token operator">:</span><span class="token string">&quot;2001-02-02&quot;</span><span class="token punctuation">,</span>
	<span class="token property">&quot;modified&quot;</span><span class="token operator">:</span><span class="token string">&quot;1562167817000&quot;</span><span class="token punctuation">,</span>
	<span class="token property">&quot;created&quot;</span><span class="token operator">:</span><span class="token string">&quot;1562167817000&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-json extra-class"><pre class="language-json"><code>POST http<span class="token operator">:</span><span class="token comment">//localhost:9200/company/employee/3?routing=1</span>
<span class="token punctuation">{</span>
	<span class="token property">&quot;id&quot;</span><span class="token operator">:</span><span class="token string">&quot;3&quot;</span><span class="token punctuation">,</span>
	<span class="token property">&quot;name&quot;</span><span class="token operator">:</span><span class="token string">&quot;王五&quot;</span><span class="token punctuation">,</span>
	<span class="token property">&quot;sex&quot;</span><span class="token operator">:</span><span class="token string">&quot;女&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;age&quot;</span><span class="token operator">:</span><span class="token number">27</span><span class="token punctuation">,</span>
	<span class="token property">&quot;birthday&quot;</span><span class="token operator">:</span><span class="token string">&quot;1992-09-01&quot;</span><span class="token punctuation">,</span>
	<span class="token property">&quot;position&quot;</span><span class="token operator">:</span><span class="token string">&quot;销售&quot;</span><span class="token punctuation">,</span>
	<span class="token property">&quot;level&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
    <span class="token property">&quot;name&quot;</span><span class="token operator">:</span><span class="token string">&quot;junior&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;parent&quot;</span><span class="token operator">:</span><span class="token string">&quot;2&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;departments&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token string">&quot;市场部&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
	<span class="token property">&quot;joinTime&quot;</span><span class="token operator">:</span><span class="token string">&quot;2010-07-01&quot;</span><span class="token punctuation">,</span>
	<span class="token property">&quot;modified&quot;</span><span class="token operator">:</span><span class="token string">&quot;1562167817000&quot;</span><span class="token punctuation">,</span>
	<span class="token property">&quot;created&quot;</span><span class="token operator">:</span><span class="token string">&quot;1562167817000&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-json extra-class"><pre class="language-json"><code>POST http<span class="token operator">:</span><span class="token comment">//localhost:9200/company/employee/4?routing=1</span>
<span class="token punctuation">{</span>
	<span class="token property">&quot;id&quot;</span><span class="token operator">:</span><span class="token string">&quot;4&quot;</span><span class="token punctuation">,</span>
	<span class="token property">&quot;name&quot;</span><span class="token operator">:</span><span class="token string">&quot;赵六&quot;</span><span class="token punctuation">,</span>
	<span class="token property">&quot;sex&quot;</span><span class="token operator">:</span><span class="token string">&quot;男&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;age&quot;</span><span class="token operator">:</span><span class="token number">29</span><span class="token punctuation">,</span>
	<span class="token property">&quot;birthday&quot;</span><span class="token operator">:</span><span class="token string">&quot;1990-10-10&quot;</span><span class="token punctuation">,</span>
	<span class="token property">&quot;position&quot;</span><span class="token operator">:</span><span class="token string">&quot;销售&quot;</span><span class="token punctuation">,</span>
	<span class="token property">&quot;level&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
    <span class="token property">&quot;name&quot;</span><span class="token operator">:</span><span class="token string">&quot;junior&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;parent&quot;</span><span class="token operator">:</span><span class="token string">&quot;2&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;departments&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token string">&quot;市场部&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
	<span class="token property">&quot;joinTime&quot;</span><span class="token operator">:</span><span class="token string">&quot;2010-08-08&quot;</span><span class="token punctuation">,</span>
	<span class="token property">&quot;modified&quot;</span><span class="token operator">:</span><span class="token string">&quot;1562167817000&quot;</span><span class="token punctuation">,</span>
	<span class="token property">&quot;created&quot;</span><span class="token operator">:</span><span class="token string">&quot;1562167817000&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-json extra-class"><pre class="language-json"><code>POST http<span class="token operator">:</span><span class="token comment">//localhost:9200/company/employee/5?routing=1</span>
<span class="token punctuation">{</span>
	<span class="token property">&quot;id&quot;</span><span class="token operator">:</span><span class="token string">&quot;5&quot;</span><span class="token punctuation">,</span>
	<span class="token property">&quot;name&quot;</span><span class="token operator">:</span><span class="token string">&quot;孙七&quot;</span><span class="token punctuation">,</span>
	<span class="token property">&quot;sex&quot;</span><span class="token operator">:</span><span class="token string">&quot;男&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;age&quot;</span><span class="token operator">:</span><span class="token number">26</span><span class="token punctuation">,</span>
	<span class="token property">&quot;birthday&quot;</span><span class="token operator">:</span><span class="token string">&quot;1993-12-10&quot;</span><span class="token punctuation">,</span>
	<span class="token property">&quot;position&quot;</span><span class="token operator">:</span><span class="token string">&quot;前端工程师&quot;</span><span class="token punctuation">,</span>
	<span class="token property">&quot;level&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
    <span class="token property">&quot;name&quot;</span><span class="token operator">:</span><span class="token string">&quot;junior&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;parent&quot;</span><span class="token operator">:</span><span class="token string">&quot;2&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;departments&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token string">&quot;研发部&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
	<span class="token property">&quot;joinTime&quot;</span><span class="token operator">:</span><span class="token string">&quot;2016-07-01&quot;</span><span class="token punctuation">,</span>
	<span class="token property">&quot;modified&quot;</span><span class="token operator">:</span><span class="token string">&quot;1562167817000&quot;</span><span class="token punctuation">,</span>
	<span class="token property">&quot;created&quot;</span><span class="token operator">:</span><span class="token string">&quot;1562167817000&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-json extra-class"><pre class="language-json"><code>POST http<span class="token operator">:</span><span class="token comment">//localhost:9200/company/employee/6?routing=1</span>
<span class="token punctuation">{</span>
	<span class="token property">&quot;id&quot;</span><span class="token operator">:</span><span class="token string">&quot;6&quot;</span><span class="token punctuation">,</span>
	<span class="token property">&quot;name&quot;</span><span class="token operator">:</span><span class="token string">&quot;周八&quot;</span><span class="token punctuation">,</span>
	<span class="token property">&quot;sex&quot;</span><span class="token operator">:</span><span class="token string">&quot;男&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;age&quot;</span><span class="token operator">:</span><span class="token number">28</span><span class="token punctuation">,</span>
	<span class="token property">&quot;birthday&quot;</span><span class="token operator">:</span><span class="token string">&quot;1994-05-11&quot;</span><span class="token punctuation">,</span>
	<span class="token property">&quot;position&quot;</span><span class="token operator">:</span><span class="token string">&quot;Java工程师&quot;</span><span class="token punctuation">,</span>
	<span class="token property">&quot;level&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
    <span class="token property">&quot;name&quot;</span><span class="token operator">:</span><span class="token string">&quot;junior&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;parent&quot;</span><span class="token operator">:</span><span class="token string">&quot;2&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;departments&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token string">&quot;研发部&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
	<span class="token property">&quot;joinTime&quot;</span><span class="token operator">:</span><span class="token string">&quot;2018-03-10&quot;</span><span class="token punctuation">,</span>
	<span class="token property">&quot;modified&quot;</span><span class="token operator">:</span><span class="token string">&quot;1562167817000&quot;</span><span class="token punctuation">,</span>
	<span class="token property">&quot;created&quot;</span><span class="token operator">:</span><span class="token string">&quot;1562167817000&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="搜索"><a href="#搜索" class="header-anchor">#</a> 搜索</h3> <ol><li>查询研发部的员工</li></ol> <div class="language-json extra-class"><pre class="language-json"><code>GET http<span class="token operator">:</span><span class="token comment">//localhost:9200/company/employee/_search</span>
<span class="token punctuation">{</span>
	<span class="token property">&quot;query&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
		<span class="token property">&quot;match&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
			<span class="token property">&quot;departments&quot;</span><span class="token operator">:</span><span class="token string">&quot;研发部&quot;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ol start="2"><li>查询在研发部且在市场部的员工</li></ol> <div class="language-json extra-class"><pre class="language-json"><code>GET http<span class="token operator">:</span><span class="token comment">//localhost:9200/company/employee/_search</span>
<span class="token punctuation">{</span>
    <span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;bool&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
        	<span class="token property">&quot;must&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">{</span>
        		<span class="token property">&quot;match&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
        			<span class="token property">&quot;departments&quot;</span><span class="token operator">:</span><span class="token string">&quot;市场部&quot;</span>
        		<span class="token punctuation">}</span>
        	<span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span>
        		<span class="token property">&quot;match&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
        			<span class="token property">&quot;departments&quot;</span><span class="token operator">:</span><span class="token string">&quot;研发部&quot;</span>
        		<span class="token punctuation">}</span>
        	<span class="token punctuation">}</span><span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>*被搜索的字段是一个数组类型，但对查询语句并没有特殊的要求。</p> <ol start="3"><li>查询name=&quot;张三&quot;的直接下属。</li></ol> <div class="language-json extra-class"><pre class="language-json"><code>GET http<span class="token operator">:</span><span class="token comment">//localhost:9200/company/employee/_search</span>
<span class="token punctuation">{</span>
    <span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;has_parent&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
        	<span class="token property">&quot;parent_type&quot;</span><span class="token operator">:</span><span class="token string">&quot;superior&quot;</span><span class="token punctuation">,</span>
        	<span class="token property">&quot;query&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
        		<span class="token property">&quot;match&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
        			<span class="token property">&quot;name&quot;</span><span class="token operator">:</span><span class="token string">&quot;张三&quot;</span>
        		<span class="token punctuation">}</span>
        	<span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ol start="4"><li>查询name=&quot;李四&quot;的直接下属。</li></ol> <div class="language-json extra-class"><pre class="language-json"><code>GET http<span class="token operator">:</span><span class="token comment">//localhost:9200/company/employee/_search</span>

<span class="token punctuation">{</span>
    <span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;has_parent&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
        	<span class="token property">&quot;parent_type&quot;</span><span class="token operator">:</span><span class="token string">&quot;staff&quot;</span><span class="token punctuation">,</span>
        	<span class="token property">&quot;query&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
        		<span class="token property">&quot;match&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
        			<span class="token property">&quot;name&quot;</span><span class="token operator">:</span><span class="token string">&quot;李四&quot;</span>
        		<span class="token punctuation">}</span>
        	<span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ol start="5"><li>查询name=&quot;王五&quot;的直接上级。</li></ol> <div class="language-json extra-class"><pre class="language-json"><code>GET http<span class="token operator">:</span><span class="token comment">//localhost:9200/company/employee/_search</span>
<span class="token punctuation">{</span>
    <span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;has_child&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
        	<span class="token property">&quot;type&quot;</span><span class="token operator">:</span><span class="token string">&quot;junior&quot;</span><span class="token punctuation">,</span>
        	<span class="token property">&quot;query&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
        		<span class="token property">&quot;match&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
        			<span class="token property">&quot;name&quot;</span><span class="token operator">:</span><span class="token string">&quot;王五&quot;</span>
        		<span class="token punctuation">}</span>
        	<span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="聚合查询"><a href="#聚合查询" class="header-anchor">#</a> 聚合查询</h4> <p>ES中的聚合查询类似MySQL中的聚合函数(avg、max等)，例如计算员工的平均年龄。</p> <div class="language-json extra-class"><pre class="language-json"><code>GET http<span class="token operator">:</span><span class="token comment">//localhost:9200/company/employee/_search?pretty</span>
<span class="token punctuation">{</span>
    <span class="token property">&quot;size&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token property">&quot;aggs&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;avg_age&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;avg&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token property">&quot;field&quot;</span><span class="token operator">:</span> <span class="token string">&quot;age&quot;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="指定字段查询"><a href="#指定字段查询" class="header-anchor">#</a> 指定字段查询</h4> <p>指定字段返回值在查询结果中指定需要返回的字段。例如只查询张三的生日。</p> <div class="language-json extra-class"><pre class="language-json"><code>GET http<span class="token operator">:</span><span class="token comment">//localhost:9200/company/employee/_search?pretty</span>
<span class="token punctuation">{</span>
    <span class="token property">&quot;_source&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;birthday&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">&quot;query&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
    	<span class="token property">&quot;match&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
    		<span class="token property">&quot;name&quot;</span><span class="token operator">:</span><span class="token string">&quot;张三&quot;</span>
    	<span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="深分页"><a href="#深分页" class="header-anchor">#</a> 深分页</h3> <p>ES的深分页是一个老生常谈的问题。用过ES的都知道，ES默认查询深度不能超过10000条，也就是page * pageSize &lt; 10000。如果需要查询超过1万条的数据，要么通过设置最大深度，要么通过<code>scroll</code>滚动查询。如果调整配置，即使能查出来，性能也会很差。但通过<code>scroll</code>滚动查询的方式带来的问题就是只能进行&quot;上一页&quot;、&quot;下一页&quot;的操作，而不能进行页码跳转。</p> <p><code>scroll</code>原理简单来讲，就是一批一批的查，上一批的最后一个数据，作为下一批的第一个数据，直到查完所有的数据。</p> <p>首先需要初始化查询</p> <div class="language-json extra-class"><pre class="language-json"><code>GET http<span class="token operator">:</span><span class="token comment">//localhost:9200/company/employee/_search?scroll=1m</span>
<span class="token punctuation">{</span>
	<span class="token property">&quot;query&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
		<span class="token property">&quot;match_all&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token property">&quot;size&quot;</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span>
	<span class="token property">&quot;_source&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><p>像普通查询结果一样进行查询，url中的scroll=1m指的是游标查询的过期时间为1分钟，每次查询就会更新，设置过长占会用过多的时间。</p> <p>接下来就可以通过上述API返回的<code>_scroll_id</code>进行滚动查询，假设上面的结果返回<code>&quot;_scroll_id&quot;: &quot;DnF1ZXJ5VGhlbkZldGNoBQAAAAAAAAFBFk1pNzdFUVhDU3hxX3VtSVFUdDJBWlEAAAAAAAABQhZNaTc3RVFYQ1N4cV91bUlRVHQyQVpRAAAAAAAAAUMWTWk3N0VRWENTeHFfdW1JUVR0MkFaUQAAAAAAAAFEFk1pNzdFUVhDU3hxX3VtSVFUdDJBWlEAAAAAAAABRRZNaTc3RVFYQ1N4cV91bUlRVHQyQVpR&quot;</code>。</p> <div class="language-json extra-class"><pre class="language-json"><code>GET http<span class="token operator">:</span><span class="token comment">//localhost:9200/_search/scroll</span>
<span class="token punctuation">{</span>
    <span class="token property">&quot;scroll&quot;</span><span class="token operator">:</span><span class="token string">&quot;1m&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;scroll_id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;DnF1ZXJ5VGhlbkZldGNoBQAAAAAAAAFBFk1pNzdFUVhDU3hxX3VtSVFUdDJBWlEAAAAAAAABQhZNaTc3RVFYQ1N4cV91bUlRVHQyQVpRAAAAAAAAAUMWTWk3N0VRWENTeHFfdW1JUVR0MkFaUQAAAAAAAAFEFk1pNzdFUVhDU3hxX3VtSVFUdDJBWlEAAAAAAAABRRZNaTc3RVFYQ1N4cV91bUlRVHQyQVpR&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这种方式有一个小小的弊端，如果超过过期时间就不能继续往下查询，这种查询适合一次全量查询所有数据。但现实情况有可能是用户在一个页面停留很长时间，再点击上一页或者下一页，此时超过过期时间页面不能再进行查询。所以还有另外一种方式，范围查询。</p> <h4 id="另一种深分页"><a href="#另一种深分页" class="header-anchor">#</a> 另一种深分页</h4> <p>假设员工数据中的工号ID是按递增且唯一的顺序，那么我们可以通过范围查询进行分页。</p> <p>例如，按ID递增排序，第一查询ID&gt;0的数据，数据量为1。</p> <div class="language-json extra-class"><pre class="language-json"><code>GET http<span class="token operator">:</span><span class="token comment">//localhost:9200/company/employee/_search</span>
<span class="token punctuation">{</span>
	<span class="token property">&quot;query&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
		<span class="token property">&quot;range&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
			<span class="token property">&quot;id&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
				<span class="token property">&quot;gt&quot;</span><span class="token operator">:</span><span class="token number">0</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token property">&quot;size&quot;</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span>
	<span class="token property">&quot;sort&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
		<span class="token property">&quot;id&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
			<span class="token property">&quot;order&quot;</span><span class="token operator">:</span><span class="token string">&quot;asc&quot;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>此时返回ID=1的1条数据，我们再继续查询ID&gt;1的数据，数据量仍然是1。</p> <div class="language-json extra-class"><pre class="language-json"><code>GET http<span class="token operator">:</span><span class="token comment">//localhost:9200/company/employee/_search</span>
<span class="token punctuation">{</span>
	<span class="token property">&quot;query&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
		<span class="token property">&quot;range&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
			<span class="token property">&quot;id&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
				<span class="token property">&quot;gt&quot;</span><span class="token operator">:</span><span class="token number">1</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token property">&quot;size&quot;</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span>
	<span class="token property">&quot;sort&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
		<span class="token property">&quot;id&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
			<span class="token property">&quot;order&quot;</span><span class="token operator">:</span><span class="token string">&quot;asc&quot;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这样我们同样做到了深分页的查询，并且没有过期时间的限制。</p> <h2 id="场景2"><a href="#场景2" class="header-anchor">#</a> 场景2</h2> <p>存储商品数据，根据商品名称搜索商品，要求准确度高，不能搜索洗面奶结果出现面粉。</p> <p>由于这个场景主要涉及的是搜索的精度问题，所以并不会有复杂的数据结构，只有一个title字段。</p> <p>定义一个只包含title字段且分词器默认为<code>standard</code>的索引：</p> <div class="language-json extra-class"><pre class="language-json"><code>PUT http<span class="token operator">:</span><span class="token comment">//localhost:9200/ware_index</span>
<span class="token punctuation">{</span>
    <span class="token property">&quot;mappings&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;ware&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;properties&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            	<span class="token property">&quot;title&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
            		<span class="token property">&quot;type&quot;</span><span class="token operator">:</span><span class="token string">&quot;text&quot;</span>
            	<span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>插入两条数据：</p> <div class="language-json extra-class"><pre class="language-json"><code>POST http<span class="token operator">:</span><span class="token comment">//localhost:9200/ware_index/ware</span>
<span class="token punctuation">{</span>
	<span class="token property">&quot;title&quot;</span><span class="token operator">:</span><span class="token string">&quot;洗面奶&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-json extra-class"><pre class="language-json"><code>POST http<span class="token operator">:</span><span class="token comment">//localhost:9200/ware_index/ware</span>
<span class="token punctuation">{</span>
	<span class="token property">&quot;title&quot;</span><span class="token operator">:</span><span class="token string">&quot;面粉&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>搜索关键字&quot;洗面奶&quot;：</p> <div class="language-json extra-class"><pre class="language-json"><code>POST http<span class="token operator">:</span><span class="token comment">//localhost:9200/ware_index/ware/_search</span>
<span class="token punctuation">{</span>
	<span class="token property">&quot;query&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
		<span class="token property">&quot;match&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
			<span class="token property">&quot;title&quot;</span><span class="token operator">:</span><span class="token string">&quot;洗面奶&quot;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>搜索结果出现了&quot;洗面奶&quot;和&quot;面粉&quot;两个风马牛不相及的结果，这显然不符合我们的预期。</p> <p>原因在<strong>分词</strong>一章中已经说明，<code>text</code>类型默认分词器为<code>standard</code>，它会将中文字符串一个字一个字拆分，也就是将&quot;洗面奶&quot;拆分成了&quot;洗&quot;、&quot;面&quot;、&quot;奶&quot;，将&quot;面粉&quot;拆分成了&quot;面&quot;、&quot;粉&quot;。而<code>match</code>会将搜索的关键词拆分，也就拆分成了&quot;洗&quot;、&quot;面&quot;、&quot;奶&quot;，最后两个&quot;面&quot;都能匹配上，也就出现了上述结果。所以对于中文的字符串搜索我们需要指定分词器，而常用的分词器是<code>ik_smart</code>，它会按照最大粒度拆分，如果采用<code>ik_max_word</code>它会将词按照最小粒度拆分，也有可能造成上述结果。</p> <p><code>DELETE http://localhost:9200/ware_index</code>删除索引，重新创建并指定title字段的分词器为<code>ik_smart</code>。</p> <div class="language-json extra-class"><pre class="language-json"><code>PUT http<span class="token operator">:</span><span class="token comment">//localhost:9200/ware_index</span>
<span class="token punctuation">{</span>
	<span class="token property">&quot;mappings&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
		<span class="token property">&quot;ware&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
			<span class="token property">&quot;properties&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
        <span class="token property">&quot;id&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
          <span class="token property">&quot;type&quot;</span><span class="token operator">:</span><span class="token string">&quot;keyword&quot;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
				<span class="token property">&quot;title&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
					<span class="token property">&quot;type&quot;</span><span class="token operator">:</span><span class="token string">&quot;text&quot;</span><span class="token punctuation">,</span>
					<span class="token property">&quot;analyzer&quot;</span><span class="token operator">:</span><span class="token string">&quot;ik_smart&quot;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这时如果插入“洗面奶”和“面粉”，搜索“洗面奶”是结果就只有一条。但此时我们插入以下两条数据：</p> <div class="language-json extra-class"><pre class="language-json"><code>POST http<span class="token operator">:</span><span class="token comment">//localhost:9200/ware_index/ware</span>
<span class="token punctuation">{</span>
    <span class="token property">&quot;id&quot;</span><span class="token operator">:</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">,</span>
  	<span class="token property">&quot;title&quot;</span><span class="token operator">:</span><span class="token string">&quot;新希望牛奶&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-json extra-class"><pre class="language-json"><code>POST http<span class="token operator">:</span><span class="token comment">//localhost:9200/ware_index/ware</span>
<span class="token punctuation">{</span>
    <span class="token property">&quot;id&quot;</span><span class="token operator">:</span><span class="token string">&quot;2&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;title&quot;</span><span class="token operator">:</span><span class="token string">&quot;春秋上新短袖&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>搜索关键字”新希望牛奶“：</p> <div class="language-json extra-class"><pre class="language-json"><code>POST http<span class="token operator">:</span><span class="token comment">//localhost:9200/ware_index/ware/_search</span>
<span class="token punctuation">{</span>
	<span class="token property">&quot;query&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
		<span class="token property">&quot;match&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
			<span class="token property">&quot;title&quot;</span><span class="token operator">:</span><span class="token string">&quot;新希望牛奶&quot;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>搜索结果出现了刚插入的2条，显然第二条”春秋上新短袖“并不是我们想要的结果。出现这种问题的原因同样是因为分词的问题，在<code>ik</code>插件的词库中并没有&quot;新希望&quot;一词，所以它会把搜索的关键词&quot;新希望&quot;拆分为&quot;新&quot;和&quot;希望&quot;，同样在&quot;春秋上新短袖&quot;中&quot;新&quot;也并没有组合成其它词语，它也被单独拆成了&quot;新&quot;，这就造成了上述结果。解决这个问题的办法当然可以在<code>ik</code>插件中新增&quot;新希望&quot;词语，如果我们在<strong>分词</strong>中所做的那样，但也有其它的办法。</p> <h3 id="短语查询"><a href="#短语查询" class="header-anchor">#</a> 短语查询</h3> <p><code>match_phrase</code>，短语查询，它会将搜索关键字&quot;新希望牛奶&quot;拆分成一个词项列表&quot;新 希望 牛奶&quot;，对于搜索的结果需要<strong>完全匹配这些词项，且位置对应</strong>，本例中的&quot;新希望牛奶&quot;文档数据从词项和位置上完全对应，故通过<code>match_phrase</code>短语查询可搜索出结果，且只有一条数据。</p> <div class="language-json extra-class"><pre class="language-json"><code>POST http<span class="token operator">:</span><span class="token comment">//localhost:9200/ware_index/ware/_search</span>
<span class="token punctuation">{</span>
    <span class="token property">&quot;query&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
        <span class="token property">&quot;match_phrase&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
            <span class="token property">&quot;title&quot;</span><span class="token operator">:</span><span class="token string">&quot;新希望牛奶&quot;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>尽管这能满足我们的搜索结果，但是用户实际在搜索中常常可能是&quot;牛奶 新希望&quot;这样的顺序，但遗憾的是根据<code>match_phrase</code>短语匹配的要求是需要被搜索的文档需要<strong>完全匹配词项且位置对应</strong>，关键字&quot;牛奶 新希望&quot;被解析成了&quot;牛奶 新 希望&quot;，尽管它与&quot;新希望牛奶&quot;词项匹配但位置没有对应，所以并不能搜索出任何结果。同理，此时如果我们插入&quot;新希望的牛奶&quot;数据时，无论是搜索&quot;新希望牛奶&quot;还是&quot;牛奶新希望&quot;均不能搜索出&quot;新希望的牛奶&quot;结果，前者的关键字是因为<strong>词项没有完全匹配</strong>，后者的关键字是因为<strong>词项和位置没有完全匹配</strong>。</p> <p>所以<code>match_phrase</code>也没有达到完美的效果。</p> <h3 id="短语前缀查询"><a href="#短语前缀查询" class="header-anchor">#</a> 短语前缀查询</h3> <p><code>match_phrase_prefix</code>，短语前缀查询，类似MySQL中的<code>like &quot;新希望%&quot;</code>，它大体上和<code>match_phrase_prefix</code>一致，也是需要满足文档数据和搜索关键字在词项和位置上保持一致，同样如果搜索&quot;牛奶新希望&quot;也不会出现任何结果。它也并没有达到我们想要的结果。</p> <h3 id="最低匹配度"><a href="#最低匹配度" class="header-anchor">#</a> 最低匹配度</h3> <p>前面两种查询中虽然能通过&quot;新希望牛奶&quot;搜索到我们想要的结果，但是对于&quot;牛奶 新希望&quot;却无能为力。接下来的这种查询方式能&quot;完美&quot;的达到我们想要的效果。</p> <p>先来看最低匹配度的查询示例：</p> <div class="language-json extra-class"><pre class="language-json"><code>POST http<span class="token operator">:</span><span class="token comment">//localhost:9200/ware_index/ware/_search</span>
<span class="token punctuation">{</span>
    <span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;match&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;title&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token string">&quot;新希望牛奶&quot;</span><span class="token punctuation">,</span>
                <span class="token property">&quot;minimum_should_match&quot;</span><span class="token operator">:</span> <span class="token string">&quot;80%&quot;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>minimum_should_match</code>即最低匹配度。&quot;80%&quot;代表什么意思呢？还是要从关键字&quot;新希望牛奶&quot;被解析成哪几个词项说起，前面说到&quot;新希望牛奶&quot;被解析成&quot;新 希望 牛奶&quot;三个词项，如果通过<code>match</code>搜索，则含有&quot;新&quot;的数据同样出现在搜索结果中。&quot;80%&quot;的含义则是3个词项必须至少匹配80% * 3 = 2.4个词项才会出现在搜索结果中，向下取整为2，即搜索的数据中需要至少包含2个词项。显然，&quot;春秋上新短袖&quot;只有1个词项，不满足<strong>最低匹配度</strong>2个词项的要求，故不会出现在搜索结果中。</p> <p>同样，如果搜索&quot;牛奶 新希望&quot;也是上述的结果，它并不是短语匹配，所以并不会要求词项所匹配的位置相同。</p> <p>可以推出，如果<code>&quot;minimum_should_match&quot;:&quot;100%&quot;</code>也就是要求完全匹配，此时要求数据中<strong>包含所有的词项</strong>，这样会出现较少的搜索结果；如果<code>&quot;minimun_should_match:0&quot;</code>此时并不代表一个词项都可以不包含，而是只需要有一个词项就能出现在搜索结果，实际上就是默认的<code>match</code>搜索，这样会出现较多的搜索结果。</p> <p>找到一个合适的值，就能有一个较好的体验，根据二八原则，以及实践表明，设置为&quot;80%&quot;能满足大部分场景，既不会多出无用的搜索结果，也不会少。</p> <div class="gitalk-container"><div id="gitalk-container"></div></div> <div class="gitalk-container"><div id="gitalk-container"></div></div> <div class="gitalk-container"><div id="gitalk-container"></div></div> <div class="gitalk-container"><div id="gitalk-container"></div></div> <div class="gitalk-container"><div id="gitalk-container"></div></div> <div class="gitalk-container"><div id="gitalk-container"></div></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/coderbook/es6/chapter7.html" class="prev">父-子关系文档</a></span> <span class="next"><a href="/coderbook/es6/chapter9.html">Java客户端（下）</a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/coderbook/assets/js/app.12a8b8f4.js" defer></script><script src="/coderbook/assets/js/2.a6e63a56.js" defer></script><script src="/coderbook/assets/js/16.068faf54.js" defer></script><script src="/coderbook/assets/js/4.dd78fc5c.js" defer></script>
  </body>
</html>
