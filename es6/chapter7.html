<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>父-子关系文档 | CoderBook</title>
    <meta name="description" content="CoderBook">
    
    
    <link rel="preload" href="/assets/css/0.styles.4c5f93b7.css" as="style"><link rel="preload" href="/assets/js/app.ada1b567.js" as="script"><link rel="preload" href="/assets/js/2.abace2d1.js" as="script"><link rel="preload" href="/assets/js/14.46744065.js" as="script"><link rel="prefetch" href="/assets/js/10.048b2296.js"><link rel="prefetch" href="/assets/js/11.6f32ae89.js"><link rel="prefetch" href="/assets/js/12.9da86373.js"><link rel="prefetch" href="/assets/js/13.090f1492.js"><link rel="prefetch" href="/assets/js/15.de197aa8.js"><link rel="prefetch" href="/assets/js/16.60357a4b.js"><link rel="prefetch" href="/assets/js/17.e4e8d195.js"><link rel="prefetch" href="/assets/js/18.4f18d69c.js"><link rel="prefetch" href="/assets/js/3.8157aed2.js"><link rel="prefetch" href="/assets/js/4.538aa75a.js"><link rel="prefetch" href="/assets/js/5.77a3aff8.js"><link rel="prefetch" href="/assets/js/6.290384a9.js"><link rel="prefetch" href="/assets/js/7.93efe7bf.js"><link rel="prefetch" href="/assets/js/8.4865de69.js"><link rel="prefetch" href="/assets/js/9.05ef765c.js">
    <link rel="stylesheet" href="/assets/css/0.styles.4c5f93b7.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">CoderBook</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/es6/index.html" class="nav-link">ElasticSearch6.x</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/es6/index.html" class="nav-link">ElasticSearch6.x</a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/es6/" class="sidebar-link">写在前面的话</a></li><li><a href="/es6/chapter1.html" class="sidebar-link">准备工作</a></li><li><a href="/es6/chapter2.html" class="sidebar-link">基本术语</a></li><li><a href="/es6/chapter3.html" class="sidebar-link">简单的API</a></li><li><a href="/es6/chapter4.html" class="sidebar-link">分词</a></li><li><a href="/es6/chapter5.html" class="sidebar-link">简单搜索</a></li><li><a href="/es6/chapter6.html" class="sidebar-link">Java客户端（上）</a></li><li><a href="/es6/chapter7.html" class="active sidebar-link">父-子关系文档</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/es6/chapter7.html#背景" class="sidebar-link">背景</a></li><li class="sidebar-sub-header"><a href="/es6/chapter7.html#问题" class="sidebar-link">问题</a></li></ul></li><li><a href="/es6/chapter8.html" class="sidebar-link">复杂搜索</a></li><li><a href="/es6/chapter9.html" class="sidebar-link">Java客户端（下）</a></li><li><a href="/es6/chapter10.html" class="sidebar-link">实战：ELK日志分析系统</a></li><li><a href="/es6/chapter11.html" class="sidebar-link">实战：多数据源同步</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="父-子关系文档"><a href="#父-子关系文档" aria-hidden="true" class="header-anchor">#</a> 父-子关系文档</h1> <blockquote><p>打虎亲兄弟，上阵父子兵。</p></blockquote> <p>本章作为<strong>复杂搜索</strong>的铺垫，介绍父子文档是为了更好的介绍复杂场景下的ES操作。</p> <p>在非关系型数据库数据库中，我们常常会有表与表的关联查询。例如学生表和成绩表的关联查询就能查出学会的信息和成绩信息。在ES中，父子关系文档就类似于表的关联查询。</p> <h2 id="背景"><a href="#背景" aria-hidden="true" class="header-anchor">#</a> 背景</h2> <p>ES5.x开始借助父子关系文档实现多表关联查询，核心是一个索引Index下可以创建多个类型Type。但ES6.x开始只允许一个索引Index下创建一个类型Type，甚至在未来的版本中将会移除创建类型Type。为了继续支持多表关联查询，ES6.x推出了<code>join</code>新类型来支持父子关系文档的创建。</p> <h2 id="问题"><a href="#问题" aria-hidden="true" class="header-anchor">#</a> 问题</h2> <p>假设现在有这样的需求场景：一个博客有多篇文章，文章有标题、内容、作者、日期等信息，同时一篇文章中会有评论，评论有评论的内容、作者、日期等信息，通过ES来存储博客的文章及评论信息。</p> <p>此时文章本身就是&quot;父&quot;，而评论就是&quot;子&quot;，这类问题也可以通过<code>nested</code>嵌套对象实现，大部分情况下<code>netsted</code>嵌套对象和<code>parent-child</code>父子对象能够互相替代，但他们仍然不同的优缺点。下面将介绍这两种数据结构。</p> <h3 id="nested嵌套对象"><a href="#nested嵌套对象" aria-hidden="true" class="header-anchor">#</a> nested嵌套对象</h3> <p>一篇文章的数据结构如下图所示：</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;title&quot;</span><span class="token operator">:</span><span class="token string">&quot;ElasticSearch6.x实战教程&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;author&quot;</span><span class="token operator">:</span><span class="token string">&quot;OKevin&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;content&quot;</span><span class="token operator">:</span><span class="token string">&quot;这是一篇水文&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;created&quot;</span><span class="token operator">:</span><span class="token number">1562141626000</span><span class="token punctuation">,</span>
    <span class="token property">&quot;comments&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">{</span>
        <span class="token property">&quot;name&quot;</span><span class="token operator">:</span><span class="token string">&quot;张三&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;content&quot;</span><span class="token operator">:</span><span class="token string">&quot;写的真菜&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;created&quot;</span><span class="token operator">:</span><span class="token number">1562141689000</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span>
        <span class="token property">&quot;name&quot;</span><span class="token operator">:</span><span class="token string">&quot;李四&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;content&quot;</span><span class="token operator">:</span><span class="token string">&quot;辣鸡&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;created&quot;</span><span class="token operator">:</span><span class="token number">1562141745000</span>
    <span class="token punctuation">}</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><p>通过RESTful API创建索引及定义映射结构：</p> <div class="language-json extra-class"><pre class="language-json"><code>PUT http<span class="token operator">:</span><span class="token comment">//localhost:9200/blog</span>
<span class="token punctuation">{</span>
	<span class="token property">&quot;mappings&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
		<span class="token property">&quot;article&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
			<span class="token property">&quot;properties&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
				<span class="token property">&quot;title&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
					<span class="token property">&quot;type&quot;</span><span class="token operator">:</span><span class="token string">&quot;text&quot;</span><span class="token punctuation">,</span>
					<span class="token property">&quot;analyzer&quot;</span><span class="token operator">:</span><span class="token string">&quot;ik_smart&quot;</span><span class="token punctuation">,</span>
					<span class="token property">&quot;fields&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
						<span class="token property">&quot;keyword&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
							<span class="token property">&quot;type&quot;</span><span class="token operator">:</span><span class="token string">&quot;keyword&quot;</span><span class="token punctuation">,</span>
							<span class="token property">&quot;ignore_above&quot;</span><span class="token operator">:</span><span class="token number">256</span>
						<span class="token punctuation">}</span>
					<span class="token punctuation">}</span>
				<span class="token punctuation">}</span><span class="token punctuation">,</span>
				<span class="token property">&quot;author&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
					<span class="token property">&quot;type&quot;</span><span class="token operator">:</span><span class="token string">&quot;text&quot;</span><span class="token punctuation">,</span>
					<span class="token property">&quot;analyzer&quot;</span><span class="token operator">:</span><span class="token string">&quot;ik_smart&quot;</span><span class="token punctuation">,</span>
					<span class="token property">&quot;fields&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
						<span class="token property">&quot;keyword&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
							<span class="token property">&quot;type&quot;</span><span class="token operator">:</span><span class="token string">&quot;keyword&quot;</span><span class="token punctuation">,</span>
							<span class="token property">&quot;ignore_above&quot;</span><span class="token operator">:</span><span class="token number">256</span>
						<span class="token punctuation">}</span>
					<span class="token punctuation">}</span>
				<span class="token punctuation">}</span><span class="token punctuation">,</span>
				<span class="token property">&quot;content&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
					<span class="token property">&quot;type&quot;</span><span class="token operator">:</span><span class="token string">&quot;text&quot;</span><span class="token punctuation">,</span>
					<span class="token property">&quot;analyzer&quot;</span><span class="token operator">:</span><span class="token string">&quot;ik_smart&quot;</span>
				<span class="token punctuation">}</span><span class="token punctuation">,</span>
				<span class="token property">&quot;created&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
					<span class="token property">&quot;type&quot;</span><span class="token operator">:</span><span class="token string">&quot;date&quot;</span>
				<span class="token punctuation">}</span><span class="token punctuation">,</span>
				<span class="token property">&quot;comments&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
					<span class="token property">&quot;type&quot;</span><span class="token operator">:</span><span class="token string">&quot;nested&quot;</span><span class="token punctuation">,</span>
					<span class="token property">&quot;properties&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
						<span class="token property">&quot;name&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
							<span class="token property">&quot;type&quot;</span><span class="token operator">:</span><span class="token string">&quot;text&quot;</span><span class="token punctuation">,</span>
							<span class="token property">&quot;analyzer&quot;</span><span class="token operator">:</span><span class="token string">&quot;ik_smart&quot;</span><span class="token punctuation">,</span>
							<span class="token property">&quot;fields&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
								<span class="token property">&quot;keyword&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
									<span class="token property">&quot;type&quot;</span><span class="token operator">:</span><span class="token string">&quot;keyword&quot;</span><span class="token punctuation">,</span>
									<span class="token property">&quot;ignore_above&quot;</span><span class="token operator">:</span><span class="token number">256</span>
								<span class="token punctuation">}</span>
							<span class="token punctuation">}</span>
						<span class="token punctuation">}</span><span class="token punctuation">,</span>
						<span class="token property">&quot;content&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
							<span class="token property">&quot;type&quot;</span><span class="token operator">:</span><span class="token string">&quot;text&quot;</span><span class="token punctuation">,</span>
							<span class="token property">&quot;analyzer&quot;</span><span class="token operator">:</span><span class="token string">&quot;ik_smart&quot;</span><span class="token punctuation">,</span>
							<span class="token property">&quot;fields&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
								<span class="token property">&quot;keyword&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
									<span class="token property">&quot;type&quot;</span><span class="token operator">:</span><span class="token string">&quot;keyword&quot;</span><span class="token punctuation">,</span>
									<span class="token property">&quot;ignore_above&quot;</span><span class="token operator">:</span><span class="token number">256</span>
								<span class="token punctuation">}</span>
							<span class="token punctuation">}</span>
						<span class="token punctuation">}</span><span class="token punctuation">,</span>
						<span class="token property">&quot;created&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
							<span class="token property">&quot;type&quot;</span><span class="token operator">:</span><span class="token string">&quot;date&quot;</span>
						<span class="token punctuation">}</span>
					<span class="token punctuation">}</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>插入数据：</p> <div class="language-json extra-class"><pre class="language-json"><code>POST http<span class="token operator">:</span><span class="token comment">//localhost:9200/blog/article</span>
<span class="token punctuation">{</span>
    <span class="token property">&quot;title&quot;</span><span class="token operator">:</span><span class="token string">&quot;ElasticSearch6.x实战教程&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;author&quot;</span><span class="token operator">:</span><span class="token string">&quot;OKevin&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;content&quot;</span><span class="token operator">:</span><span class="token string">&quot;这是一篇水文&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;created&quot;</span><span class="token operator">:</span><span class="token number">1562141626000</span><span class="token punctuation">,</span>
    <span class="token property">&quot;comments&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">{</span>
        <span class="token property">&quot;name&quot;</span><span class="token operator">:</span><span class="token string">&quot;张三&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;content&quot;</span><span class="token operator">:</span><span class="token string">&quot;写的真菜&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;created&quot;</span><span class="token operator">:</span><span class="token number">1562141689000</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span>
        <span class="token property">&quot;name&quot;</span><span class="token operator">:</span><span class="token string">&quot;李四&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;content&quot;</span><span class="token operator">:</span><span class="token string">&quot;辣鸡&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;created&quot;</span><span class="token operator">:</span><span class="token number">1562141745000</span>
    <span class="token punctuation">}</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-json extra-class"><pre class="language-json"><code>POST http<span class="token operator">:</span><span class="token comment">//localhost:9200/blog/article</span>
<span class="token punctuation">{</span>
    <span class="token property">&quot;title&quot;</span><span class="token operator">:</span><span class="token string">&quot;ElasticSearch6.x从入门到放弃&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;author&quot;</span><span class="token operator">:</span><span class="token string">&quot;OKevin&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;content&quot;</span><span class="token operator">:</span><span class="token string">&quot;这是一篇ES从入门到放弃文章&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;created&quot;</span><span class="token operator">:</span><span class="token number">1562144089000</span><span class="token punctuation">,</span>
    <span class="token property">&quot;comments&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">{</span>
        <span class="token property">&quot;name&quot;</span><span class="token operator">:</span><span class="token string">&quot;张三&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;content&quot;</span><span class="token operator">:</span><span class="token string">&quot;我已入门&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;created&quot;</span><span class="token operator">:</span><span class="token number">1562144089000</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span>
        <span class="token property">&quot;name&quot;</span><span class="token operator">:</span><span class="token string">&quot;李四&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;content&quot;</span><span class="token operator">:</span><span class="token string">&quot;我已放弃&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;created&quot;</span><span class="token operator">:</span><span class="token number">1562144089000</span>
    <span class="token punctuation">}</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-json extra-class"><pre class="language-json"><code>POST http<span class="token operator">:</span><span class="token comment">//localhost:9200/blog/article</span>
<span class="token punctuation">{</span>
    <span class="token property">&quot;title&quot;</span><span class="token operator">:</span><span class="token string">&quot;ElasticSearch6.x原理解析&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;author&quot;</span><span class="token operator">:</span><span class="token string">&quot;专家&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;content&quot;</span><span class="token operator">:</span><span class="token string">&quot;这是一篇ES原理解析的文章&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;created&quot;</span><span class="token operator">:</span><span class="token number">1562144089000</span><span class="token punctuation">,</span>
    <span class="token property">&quot;comments&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">{</span>
        <span class="token property">&quot;name&quot;</span><span class="token operator">:</span><span class="token string">&quot;张三&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;content&quot;</span><span class="token operator">:</span><span class="token string">&quot;牛逼，专家就是不一样&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;created&quot;</span><span class="token operator">:</span><span class="token number">1562144089000</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span>
        <span class="token property">&quot;name&quot;</span><span class="token operator">:</span><span class="token string">&quot;李四&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;content&quot;</span><span class="token operator">:</span><span class="token string">&quot;大牛&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;created&quot;</span><span class="token operator">:</span><span class="token number">1562144089000</span>
    <span class="token punctuation">}</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><ol><li>查询作者为“OKevin”文章的所有评论（父查子）</li></ol> <div class="language-json extra-class"><pre class="language-json"><code>GET http<span class="token operator">:</span><span class="token comment">//localhost:9200/blog/article/_search</span>
<span class="token punctuation">{</span>
	<span class="token property">&quot;query&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
		<span class="token property">&quot;bool&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
			<span class="token property">&quot;must&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">{</span>
				<span class="token property">&quot;match&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
					<span class="token property">&quot;author.keyword&quot;</span><span class="token operator">:</span><span class="token string">&quot;OKevin&quot;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span><span class="token punctuation">]</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>ES结果返回2条作者为&quot;OKevin&quot;的全部数据。</p> <ol start="2"><li>查询评论中含有“辣鸡”的文章（子查父）</li></ol> <div class="language-json extra-class"><pre class="language-json"><code>GET http<span class="token operator">:</span><span class="token comment">//localhost:9200/blog/article/_search</span>
<span class="token punctuation">{</span>
	<span class="token property">&quot;query&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
		<span class="token property">&quot;bool&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
			<span class="token property">&quot;must&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">{</span>
				<span class="token property">&quot;match&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
					<span class="token property">&quot;author.keyword&quot;</span><span class="token operator">:</span><span class="token string">&quot;OKevin&quot;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span>
				<span class="token property">&quot;nested&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
					<span class="token property">&quot;path&quot;</span><span class="token operator">:</span><span class="token string">&quot;comments&quot;</span><span class="token punctuation">,</span>
					<span class="token property">&quot;query&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
						<span class="token property">&quot;bool&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
							<span class="token property">&quot;must&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">{</span>
								<span class="token property">&quot;match&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
									<span class="token property">&quot;comments.content&quot;</span><span class="token operator">:</span><span class="token string">&quot;辣鸡&quot;</span>
								<span class="token punctuation">}</span>
							<span class="token punctuation">}</span><span class="token punctuation">]</span>
						<span class="token punctuation">}</span>
					<span class="token punctuation">}</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span><span class="token punctuation">]</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>ES确实只返回了包含&quot;辣鸡&quot;的数据。</p> <p>两次查询都直接返回了整个文档数据。</p> <h3 id="parent-child父子文档"><a href="#parent-child父子文档" aria-hidden="true" class="header-anchor">#</a> parent-child父子文档</h3> <p>既然父子文档能实现表的关联查询，那它的数据结构就应该是这样：</p> <p>文章数据结构</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;title&quot;</span><span class="token operator">:</span><span class="token string">&quot;ElasticSearch6.x实战教程&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;author&quot;</span><span class="token operator">:</span><span class="token string">&quot;OKevin&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;content&quot;</span><span class="token operator">:</span><span class="token string">&quot;这是一篇实战教程&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;created&quot;</span><span class="token operator">:</span><span class="token number">1562141626000</span><span class="token punctuation">,</span>
    <span class="token property">&quot;comments&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><p>评论数据结构</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;name&quot;</span><span class="token operator">:</span><span class="token string">&quot;张三&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;content&quot;</span><span class="token operator">:</span><span class="token string">&quot;写的真菜&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;created&quot;</span><span class="token operator">:</span><span class="token number">1562141689000</span>
<span class="token punctuation">}</span>
</code></pre></div><p>ES6.x以前是将这两个结构分别存储在两个类型Type中关联(这看起来更接近关系型数据库表与表的关联查询)，但在ES6.x开始一个索引Index只能创建一个类型Type，要再想实现表关联查询，就意味着需要把上述两张表揉在一起，ES6.x由此定义了一个新的数据类型——<code>join</code>。</p> <p>通过RESTful API创建索引及定义映射结构：</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
	<span class="token property">&quot;mappings&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
		<span class="token property">&quot;article&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
			<span class="token property">&quot;properties&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
				<span class="token property">&quot;title&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
					<span class="token property">&quot;type&quot;</span><span class="token operator">:</span><span class="token string">&quot;text&quot;</span><span class="token punctuation">,</span>
					<span class="token property">&quot;analyzer&quot;</span><span class="token operator">:</span><span class="token string">&quot;ik_smart&quot;</span><span class="token punctuation">,</span>
					<span class="token property">&quot;fields&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
						<span class="token property">&quot;keyword&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
							<span class="token property">&quot;type&quot;</span><span class="token operator">:</span><span class="token string">&quot;keyword&quot;</span><span class="token punctuation">,</span>
							<span class="token property">&quot;ignore_above&quot;</span><span class="token operator">:</span><span class="token number">256</span>
						<span class="token punctuation">}</span>
					<span class="token punctuation">}</span>
				<span class="token punctuation">}</span><span class="token punctuation">,</span>
				<span class="token property">&quot;author&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
					<span class="token property">&quot;type&quot;</span><span class="token operator">:</span><span class="token string">&quot;text&quot;</span><span class="token punctuation">,</span>
					<span class="token property">&quot;analyzer&quot;</span><span class="token operator">:</span><span class="token string">&quot;ik_smart&quot;</span><span class="token punctuation">,</span>
					<span class="token property">&quot;fields&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
						<span class="token property">&quot;keyword&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
							<span class="token property">&quot;type&quot;</span><span class="token operator">:</span><span class="token string">&quot;keyword&quot;</span><span class="token punctuation">,</span>
							<span class="token property">&quot;ignore_above&quot;</span><span class="token operator">:</span><span class="token number">256</span>
						<span class="token punctuation">}</span>
					<span class="token punctuation">}</span>
				<span class="token punctuation">}</span><span class="token punctuation">,</span>
				<span class="token property">&quot;content&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
					<span class="token property">&quot;type&quot;</span><span class="token operator">:</span><span class="token string">&quot;text&quot;</span><span class="token punctuation">,</span>
					<span class="token property">&quot;analyzer&quot;</span><span class="token operator">:</span><span class="token string">&quot;ik_smart&quot;</span>
				<span class="token punctuation">}</span><span class="token punctuation">,</span>
				<span class="token property">&quot;created&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
					<span class="token property">&quot;type&quot;</span><span class="token operator">:</span><span class="token string">&quot;date&quot;</span>
				<span class="token punctuation">}</span><span class="token punctuation">,</span>
				<span class="token property">&quot;comments&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
					<span class="token property">&quot;type&quot;</span><span class="token operator">:</span><span class="token string">&quot;join&quot;</span><span class="token punctuation">,</span>
					<span class="token property">&quot;relations&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
						<span class="token property">&quot;article&quot;</span><span class="token operator">:</span><span class="token string">&quot;comment&quot;</span>
					<span class="token punctuation">}</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>重点关注其中的&quot;comments&quot;字段，可以看到类型定义为<code>join</code>，relations定义了谁是父谁是子，&quot;article&quot;:&quot;comment&quot;表示article是父comment是子。</p> <p>父子文档的插入是父与子分别插入(因为可以理解为把多个表塞到了一张表里)。</p> <p>插入父文档：</p> <div class="language-json extra-class"><pre class="language-json"><code>POST http<span class="token operator">:</span><span class="token comment">//localhost:9200/blog/article/1</span>
<span class="token punctuation">{</span>
    <span class="token property">&quot;title&quot;</span><span class="token operator">:</span><span class="token string">&quot;ElasticSearch6.x实战教程&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;author&quot;</span><span class="token operator">:</span><span class="token string">&quot;OKevin&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;content&quot;</span><span class="token operator">:</span><span class="token string">&quot;这是一篇水文&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;created&quot;</span><span class="token operator">:</span><span class="token number">1562141626000</span><span class="token punctuation">,</span>
    <span class="token property">&quot;comments&quot;</span><span class="token operator">:</span><span class="token string">&quot;article&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-json extra-class"><pre class="language-json"><code>POST http<span class="token operator">:</span><span class="token comment">//localhost:9200/blog/article/2</span>
<span class="token punctuation">{</span>
    <span class="token property">&quot;title&quot;</span><span class="token operator">:</span><span class="token string">&quot;ElasticSearch6.x从入门到放弃&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;author&quot;</span><span class="token operator">:</span><span class="token string">&quot;OKevin&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;content&quot;</span><span class="token operator">:</span><span class="token string">&quot;这是一篇ES从入门到放弃文章&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;created&quot;</span><span class="token operator">:</span><span class="token number">1562144089000</span><span class="token punctuation">,</span>
    <span class="token property">&quot;comments&quot;</span><span class="token operator">:</span><span class="token string">&quot;article&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-json extra-class"><pre class="language-json"><code>POST http<span class="token operator">:</span><span class="token comment">//localhost:9200/blog/article/3</span>
<span class="token punctuation">{</span>
    <span class="token property">&quot;title&quot;</span><span class="token operator">:</span><span class="token string">&quot;ElasticSearch6.x原理解析&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;author&quot;</span><span class="token operator">:</span><span class="token string">&quot;专家&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;content&quot;</span><span class="token operator">:</span><span class="token string">&quot;这是一篇ES原理解析的文章&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;created&quot;</span><span class="token operator">:</span><span class="token number">1562144089000</span><span class="token punctuation">,</span>
    <span class="token property">&quot;comments&quot;</span><span class="token operator">:</span><span class="token string">&quot;article&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>插入子文档：</p> <div class="language-json extra-class"><pre class="language-json"><code>POST http<span class="token operator">:</span><span class="token comment">//localhost:9200/blog/article/4?routing=1</span>
<span class="token punctuation">{</span>
    <span class="token property">&quot;name&quot;</span><span class="token operator">:</span><span class="token string">&quot;张三&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;content&quot;</span><span class="token operator">:</span><span class="token string">&quot;写的真菜&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;created&quot;</span><span class="token operator">:</span><span class="token number">1562141689000</span><span class="token punctuation">,</span>
    <span class="token property">&quot;comments&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
    	<span class="token property">&quot;name&quot;</span><span class="token operator">:</span><span class="token string">&quot;comment&quot;</span><span class="token punctuation">,</span>
    	<span class="token property">&quot;parent&quot;</span><span class="token operator">:</span><span class="token number">1</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-json extra-class"><pre class="language-json"><code>POST http<span class="token operator">:</span><span class="token comment">//localhost:9200/blog/article/5?routing=1</span>
<span class="token punctuation">{</span>
    <span class="token property">&quot;name&quot;</span><span class="token operator">:</span><span class="token string">&quot;李四&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;content&quot;</span><span class="token operator">:</span><span class="token string">&quot;辣鸡&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;created&quot;</span><span class="token operator">:</span><span class="token number">1562141745000</span><span class="token punctuation">,</span>
    <span class="token property">&quot;comments&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
    	<span class="token property">&quot;name&quot;</span><span class="token operator">:</span><span class="token string">&quot;comment&quot;</span><span class="token punctuation">,</span>
    	<span class="token property">&quot;parent&quot;</span><span class="token operator">:</span><span class="token number">1</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-json extra-class"><pre class="language-json"><code>POST http<span class="token operator">:</span><span class="token comment">//localhost:9200/blog/article/6?routing=2</span>
<span class="token punctuation">{</span>
    <span class="token property">&quot;name&quot;</span><span class="token operator">:</span><span class="token string">&quot;张三&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;content&quot;</span><span class="token operator">:</span><span class="token string">&quot;我已入门&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;created&quot;</span><span class="token operator">:</span><span class="token number">1562144089000</span><span class="token punctuation">,</span>
    <span class="token property">&quot;comments&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
    	<span class="token property">&quot;name&quot;</span><span class="token operator">:</span><span class="token string">&quot;comment&quot;</span><span class="token punctuation">,</span>
    	<span class="token property">&quot;parent&quot;</span><span class="token operator">:</span><span class="token number">2</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-json extra-class"><pre class="language-json"><code>POST http<span class="token operator">:</span><span class="token comment">//localhost:9200/blog/article/7?routing=2</span>
<span class="token punctuation">{</span>
    <span class="token property">&quot;name&quot;</span><span class="token operator">:</span><span class="token string">&quot;李四&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;content&quot;</span><span class="token operator">:</span><span class="token string">&quot;我已放弃&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;created&quot;</span><span class="token operator">:</span><span class="token number">1562144089000</span><span class="token punctuation">,</span>
    <span class="token property">&quot;comments&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
    	<span class="token property">&quot;name&quot;</span><span class="token operator">:</span><span class="token string">&quot;comment&quot;</span><span class="token punctuation">,</span>
    	<span class="token property">&quot;parent&quot;</span><span class="token operator">:</span><span class="token number">2</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-json extra-class"><pre class="language-json"><code>POST http<span class="token operator">:</span><span class="token comment">//localhost:9200/blog/article/8?routing=3</span>
<span class="token punctuation">{</span>
    <span class="token property">&quot;name&quot;</span><span class="token operator">:</span><span class="token string">&quot;张三&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;content&quot;</span><span class="token operator">:</span><span class="token string">&quot;牛逼，专家就是不一样&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;created&quot;</span><span class="token operator">:</span><span class="token number">1562144089000</span><span class="token punctuation">,</span>
    <span class="token property">&quot;comments&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
    	<span class="token property">&quot;name&quot;</span><span class="token operator">:</span><span class="token string">&quot;comment&quot;</span><span class="token punctuation">,</span>
    	<span class="token property">&quot;parent&quot;</span><span class="token operator">:</span><span class="token number">3</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-json extra-class"><pre class="language-json"><code>POST http<span class="token operator">:</span><span class="token comment">//localhost:9200/blog/article/9?routing=3</span>
<span class="token punctuation">{</span>
    <span class="token property">&quot;name&quot;</span><span class="token operator">:</span><span class="token string">&quot;李四&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;content&quot;</span><span class="token operator">:</span><span class="token string">&quot;大牛&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;created&quot;</span><span class="token operator">:</span><span class="token number">1562144089000</span><span class="token punctuation">,</span>
    <span class="token property">&quot;comments&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
    	<span class="token property">&quot;name&quot;</span><span class="token operator">:</span><span class="token string">&quot;comment&quot;</span><span class="token punctuation">,</span>
    	<span class="token property">&quot;parent&quot;</span><span class="token operator">:</span><span class="token number">3</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>如果查询索引数据会发现一共有9条数据，并不是<code>nested</code>那样将&quot;评论&quot;嵌套&quot;文章&quot;中的。</p> <ol><li>查询作者为“OKevin”文章的所有评论（父查子）</li></ol> <div class="language-json extra-class"><pre class="language-json"><code>GET http<span class="token operator">:</span><span class="token comment">//localhost:9200/blog/article/_search</span>
<span class="token punctuation">{</span>
	<span class="token property">&quot;query&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
		<span class="token property">&quot;has_parent&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
			<span class="token property">&quot;parent_type&quot;</span><span class="token operator">:</span><span class="token string">&quot;article&quot;</span><span class="token punctuation">,</span>
			<span class="token property">&quot;query&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
				<span class="token property">&quot;match&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
					<span class="token property">&quot;author.keyword&quot;</span><span class="token operator">:</span><span class="token string">&quot;OKevin&quot;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>ES只返回了comment评论结构中的数据，而不是全部包括文章数据也返回。这是嵌套对象查询与父子文档查询的区别之一——<strong>子文档可以单独返回</strong>。</p> <ol start="2"><li>查询评论中含有“辣鸡”的文章（子查父）</li></ol> <div class="language-json extra-class"><pre class="language-json"><code>GET http<span class="token operator">:</span><span class="token comment">//localhost:9200/blog/artice/_search</span>
<span class="token punctuation">{</span>
	<span class="token property">&quot;query&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
		<span class="token property">&quot;has_child&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
			<span class="token property">&quot;type&quot;</span><span class="token operator">:</span><span class="token string">&quot;comment&quot;</span><span class="token punctuation">,</span>
			<span class="token property">&quot;query&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
				<span class="token property">&quot;match&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
					<span class="token property">&quot;content&quot;</span><span class="token operator">:</span><span class="token string">&quot;辣鸡&quot;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>ES同样也只返回了父文档的数据，而没有子文档(评论)的数据。</p> <p><code>nested</code>嵌套对象和<code>parent-child</code>父子文档之间最大的区别，嵌套对象中的&quot;父子&quot;是一个文档数据，而父子文档的中的&quot;父子&quot;是两个文档数据。这意味着嵌套对象中如果涉及对嵌套文档的操作会对整个文档造成影响（重新索引，但查询快），包括修改、删除、查询。而父子文档子文档或者父文档本身就是<strong>独立</strong>的文档，对子文档或者父文档的操作并不会相互影响（不会重新索引，查询相对慢）。</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/es6/chapter6.html" class="prev">Java客户端（上）</a></span> <span class="next"><a href="/es6/chapter8.html">复杂搜索</a>→
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.ada1b567.js" defer></script><script src="/assets/js/2.abace2d1.js" defer></script><script src="/assets/js/14.46744065.js" defer></script>
  </body>
</html>
